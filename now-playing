#!/bin/bash

# === CONFIGURATION ===
TAUTULLI_API_KEY="yourapikey"
TAUTULLI_URL="http://localhost:8181"

# === COLORS ===
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
PURPLE="\033[0;35m"
CYAN="\033[1;36m"
WHITE="\033[1;37m"
NC="\033[0m"

# === ARGUMENT FLAGS ===
REBOOT_REQUESTED=false
SHOW_LIBRARY=false
SHOW_HELP=false
WATCH_MODE=false
WATCH_INTERVAL=10

for arg in "$@"; do
  case $arg in
    --reboot)
      REBOOT_REQUESTED=true
      ;;
    --library|-l)
      SHOW_LIBRARY=true
      ;;
    --help|-h)
      SHOW_HELP=true
      ;;
    --watch)
      WATCH_MODE=true
      ;;
  esac
done

# === FUNCTION: Format Seconds to HH:MM:SS ===
format_time() {
  local seconds=$1
  printf '%02d:%02d:%02d' $((seconds / 3600)) $((seconds % 3600 / 60)) $((seconds % 60))
}

# === HANDLE HELP FLAG ===
if [ "$SHOW_HELP" = true ]; then
  echo -e "${CYAN}Usage: now-playing [OPTIONS]${NC}"
  echo -e "\nOptions:"
  echo -e "  ${GREEN}--reboot${NC}          Prompt to reboot the system if no streams are active (warn if active)."
  echo -e "  ${GREEN}-l, --library${NC}     Show Plex library statistics."
  echo -e "  ${GREEN}--watch${NC}           Enter real-time monitoring mode (updates every 10s)."
  echo -e "  ${GREEN}-h, --help${NC}        Display this help message."
  exit 0
fi

# === HANDLE LIBRARY STATS ===
if [ "$SHOW_LIBRARY" = true ]; then
  echo -e "${CYAN}Fetching Plex library stats...${NC}"
  lib_json=$(curl -s "${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_libraries")

  echo "$lib_json" | jq -r '.response.data[] | "\(.section_name) (\(.section_type)) - \(.count) items"' | while read -r line; do
    echo -e " - ${GREEN}${line}${NC}"
  done
  echo
  exit 0
fi

# === HANDLE WATCH MODE ===
if [ "$WATCH_MODE" = true ]; then
  declare -A offsets durations states titles users session_ids platforms players versions \
            transcode_decisions video_decisions audio_decisions

  last_sync_time=0

  while true; do
    current_time=$(date +%s)

    if (( current_time - last_sync_time >= WATCH_INTERVAL )); then
      json=$(curl -s "${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_activity")
      active_streams=$(echo "$json" | jq '.response.data.sessions | length')

      unset offsets durations states titles users session_ids platforms players versions
      unset transcode_decisions video_decisions audio_decisions
      declare -A offsets durations states titles users session_ids platforms players versions
      declare -A transcode_decisions video_decisions audio_decisions

      sessions=$(echo "$json" | jq -c '.response.data.sessions[]')
      while IFS= read -r session; do
        session_id=$(echo "$session" | jq -r '.session_id')
        user=$(echo "$session" | jq -r '.user')
        title=$(echo "$session" | jq -r '.full_title')
        offset=$(echo "$session" | jq -r '.view_offset')
        duration=$(echo "$session" | jq -r '.duration')
        state=$(echo "$session" | jq -r '.state')
        platform=$(echo "$session" | jq -r '.platform')
        player=$(echo "$session" | jq -r '.player')
        version=$(echo "$session" | jq -r '.product_version')
        transcode_decision=$(echo "$session" | jq -r '.transcode_decision')
        video_decision=$(echo "$session" | jq -r '.video_decision')
        audio_decision=$(echo "$session" | jq -r '.audio_decision')

        if [[ "$offset" != "null" && "$duration" != "null" ]]; then
          users["$session_id"]="$user"
          titles["$session_id"]="$title"
          offsets["$session_id"]=$((offset / 1000))
          durations["$session_id"]=$((duration / 1000))
          states["$session_id"]="$state"
          platforms["$session_id"]="$platform"
          players["$session_id"]="$player"
          versions["$session_id"]="$version"
          transcode_decisions["$session_id"]="$transcode_decision"
          video_decisions["$session_id"]="$video_decision"
          audio_decisions["$session_id"]="$audio_decision"
          session_ids["$session_id"]=1
        fi
      done <<< "$sessions"

      last_sync_time=$current_time
    fi

    clear
    echo -e "${YELLOW}---------------------------------------------${NC}"
    echo -e "${GREEN}${#session_ids[@]} active session(s)${NC}"
    echo -e "${YELLOW}---------------------------------------------${NC}"

    for session_id in "${!session_ids[@]}"; do
      user="${users[$session_id]}"
      title="${titles[$session_id]}"
      offset=${offsets[$session_id]}
      duration=${durations[$session_id]}
      state="${states[$session_id]}"
      platform="${platforms[$session_id]}"
      player="${players[$session_id]}"
      version="${versions[$session_id]}"
      transcode_decision="${transcode_decisions[$session_id]}"
      video_decision="${video_decisions[$session_id]}"
      audio_decision="${audio_decisions[$session_id]}"

      if [[ "$state" == "playing" ]]; then
        time_elapsed=$(( $(date +%s) - last_sync_time ))
        offset=$((offset + time_elapsed))
        if (( offset > duration )); then
          offset=$duration
        fi
      fi

      progress=$(format_time "$offset")
      total=$(format_time "$duration")

      echo -e "${RED}User:${NC} $user"
      echo -e "${WHITE}Title:${NC} $title"
      echo -e "${RED}State:${NC} $state"
      echo -e "${PURPLE}Progress:${NC} $progress / $total"
      echo -e "${GREEN}Player:${NC} ${player} - ${platform} ${version}"

      if [ "$transcode_decision" = "transcode" ]; then
        if [ "$video_decision" = "transcode" ] && [ "$audio_decision" = "transcode" ]; then
          stream_info="${RED}Transcode: Audio + Video${NC}"
        elif [ "$video_decision" = "transcode" ]; then
          stream_info="${YELLOW}Transcode: Video only${NC}"
        elif [ "$audio_decision" = "transcode" ]; then
          stream_info="${YELLOW}Transcode: Audio only${NC}"
        else
          stream_info="${YELLOW}Transcode (unspecified)${NC}"
        fi
      else
        stream_info="${GREEN}${transcode_decision^}${NC}"
      fi

      echo -e "${CYAN}Stream:${NC} $stream_info"
      echo -e "${YELLOW}---------------------------------------------${NC}"
    done

    sleep 1
  done
fi

# === FETCH SESSION DATA ===
json=$(curl -s "${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_activity")
active_streams=$(echo "$json" | jq '.response.data.sessions | length')

# === DISPLAY ACTIVE SESSIONS OR HANDLE REBOOT ===
if [[ "$active_streams" -eq 0 ]]; then
  echo -e "${GREEN}No active sessions.${NC}"
else
  echo -e "${YELLOW}---------------------------------------------${NC}"
  echo -e "${GREEN}${active_streams} active session(s)${NC}"
  echo -e "${YELLOW}---------------------------------------------${NC}"

  echo "$json" | jq -c '.response.data.sessions[]' | while read -r session; do
    user=$(echo "$session" | jq -r '.user')
    location=$(echo "$session" | jq -r '.stream_location')
    ip=$(echo "$session" | jq -r '.ip_address')
    type=$(echo "$session" | jq -r '.media_type')
    title=$(echo "$session" | jq -r '.full_title')
    state=$(echo "$session" | jq -r '.state')
    player=$(echo "$session" | jq -r '.player')
    platform=$(echo "$session" | jq -r '.platform')
    version=$(echo "$session" | jq -r '.product_version')
    transcode_decision=$(echo "$session" | jq -r '.transcode_decision')
    video_decision=$(echo "$session" | jq -r '.video_decision')
    audio_decision=$(echo "$session" | jq -r '.audio_decision')
    view_offset=$(echo "$session" | jq -r '.view_offset')
    duration=$(echo "$session" | jq -r '.duration')

    echo -e "${RED}User:${NC} $user"
    echo -e "${CYAN}Type:${NC} $type"
    echo -e "${WHITE}Title:${NC} $title"
    echo -e "${RED}State:${NC} $state"

    if [[ "$duration" != "null" && "$view_offset" != "null" ]]; then
      current_seconds=$((view_offset / 1000))
      total_seconds=$((duration / 1000))
      current_time=$(format_time "$current_seconds")
      total_time=$(format_time "$total_seconds")
      echo -e "${PURPLE}Progress:${NC} $current_time / $total_time"
    fi

    echo -e "${GREEN}Player:${NC} ${player} - ${platform} ${version}"

    if [ "$transcode_decision" = "transcode" ]; then
      if [ "$video_decision" = "transcode" ] && [ "$audio_decision" = "transcode" ]; then
        stream_info="${RED}Transcode: Audio + Video${NC}"
      elif [ "$video_decision" = "transcode" ]; then
        stream_info="${YELLOW}Transcode: Video only${NC}"
      elif [ "$audio_decision" = "transcode" ]; then
        stream_info="${YELLOW}Transcode: Audio only${NC}"
      else
        stream_info="${YELLOW}Transcode (unspecified)${NC}"
      fi
    else
      stream_info="${GREEN}${transcode_decision^}${NC}"
    fi

    echo -e "${CYAN}Stream:${NC} $stream_info"
    echo -e "${YELLOW}---------------------------------------------${NC}"
  done
fi

# === OPTIONAL REBOOT PROMPT ===
if [ "$REBOOT_REQUESTED" = true ]; then
  echo
  if [[ "$active_streams" -gt 0 ]]; then
    echo -e "${RED}Warning: Rebooting now will kill all active Plex streams!${NC}"
  else
    echo -e "${YELLOW}No active sessions. Safe to reboot.${NC}"
  fi
  echo -ne "${YELLOW}Would you like to reboot the system now? (y/N): ${NC}"
  read -r confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo -e "${RED}Rebooting...${NC}"
    sudo reboot
  else
    echo -e "${CYAN}Reboot cancelled.${NC}"
  fi
fi
